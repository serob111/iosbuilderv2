name: Capacitor iOS IPA Builder (Unsigned)

on:
  workflow_dispatch:

jobs:
  build_ios_ipa:
    runs-on: macos-latest

    steps:
      - name: üì• Checkout repository code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: |
          npm install @capacitor/core @capacitor/ios
          npm install -g @capacitor/cli

      - name: üìù Create Capacitor Config
        run: |
          echo '{
            "appId": "com.ipa.builder",
            "appName": "IPABuilderApp",
            "webDir": "www",
            "bundledWebRuntime": false
          }' > capacitor.config.json

      - name: ‚ûï Add iOS Platform
        run: npx cap add ios

      - name: üõ†Ô∏è Install CocoaPods
        run: gem install cocoapods

      - name: üîÑ Capacitor Sync
        run: npx cap sync ios

      - name: üèóÔ∏è Pod Install (iOS)
        run: cd ios/App && pod install --repo-update

      - name: üçé Build iOS (Unsigned IPA manually)
        run: |
          BUILD_DIR=$(pwd)/build
          mkdir -p $BUILD_DIR

          # 1Ô∏è‚É£ Build the .app (no signing)
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            BUILD_DIR="$BUILD_DIR" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="-" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM=""

          # 2Ô∏è‚É£ Find built .app
          APP_PATH=$(find $BUILD_DIR/Release-iphoneos -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå ERROR: .app not found. Build likely failed."
            exit 1
          fi
          echo "‚úÖ Found app at: $APP_PATH"

          # 3Ô∏è‚É£ Create Payload folder (structure required for .ipa)
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          # 4Ô∏è‚É£ Zip into IPA
          zip -r MyApp_unsigned.ipa Payload

          # 5Ô∏è‚É£ Move to build output
          mkdir -p build/ipa
          mv MyApp_unsigned.ipa build/ipa/

      - name: ‚¨ÜÔ∏è Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-Unsigned-IPA
          path: build/ipa/MyApp_unsigned.ipa
          retention-days: 1
