name: Capacitor iOS IPA Builder (Unsigned)

on:
  workflow_dispatch:

jobs:
  build_ios_ipa:
    runs-on: macos-latest

    steps:
      - name: ðŸ“¥ Checkout repository code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install @capacitor/core @capacitor/ios
          npm install -g @capacitor/cli

      - name: ðŸ“ Create Capacitor Config
        run: |
          echo '{
            "appId": "com.ipa.builder",
            "appName": "Parma nel Mondo",
            "webDir": "www",
            "bundledWebRuntime": false
          }' > capacitor.config.json

      - name: âž• Add iOS Platform
        run: npx cap add ios

      - name: ðŸ“¸ Install ImageMagick
        run: brew install imagemagick

      - name: ðŸŽ¨ Replace iOS App Icons
        env:
          ICON_URL: "https://appsgeyser.io/geticon.php?widget=Parma%20nel%20Mondo_18714670&width=512"
        run: |
          ICONS_DIR="ios/App/App/Assets.xcassets/AppIcon.appiconset"

          echo "ðŸ”„ Downloading icon..."
          curl -L "$ICON_URL" -o icon.png

          echo "ðŸ—‘ Removing old icons..."
          rm -rf "$ICONS_DIR"
          mkdir -p "$ICONS_DIR"

          echo "ðŸŽ¨ Generating new iOS icons..."

          sizes=(20 29 40 60 76 83.5)
          scales=(2 3)

          for size in "${sizes[@]}"; do
            for scale in "${scales[@]}"; do
              px=$(printf "%.0f" "$(echo "$size * $scale" | bc)")
              filename="icon-${size}@${scale}x.png"
              convert icon.png -resize ${px}x${px} "$ICONS_DIR/$filename"
            done
          done

          convert icon.png -resize 1024x1024 "$ICONS_DIR/Icon-AppStore-1024.png"

          echo "ðŸ“ Creating Contents.json..."
          cat > "$ICONS_DIR/Contents.json" <<EOF
{
  "images": [
    { "size": "20x20", "idiom": "iphone", "filename": "icon-20@2x.png", "scale": "2x" },
    { "size": "20x20", "idiom": "iphone", "filename": "icon-20@3x.png", "scale": "3x" },

    { "size": "29x29", "idiom": "iphone", "filename": "icon-29@2x.png", "scale": "2x" },
    { "size": "29x29", "idiom": "iphone", "filename": "icon-29@3x.png", "scale": "3x" },

    { "size": "40x40", "idiom": "iphone", "filename": "icon-40@2x.png", "scale": "2x" },
    { "size": "40x40", "idiom": "iphone", "filename": "icon-40@3x.png", "scale": "3x" },

    { "size": "60x60", "idiom": "iphone", "filename": "icon-60@2x.png", "scale": "2x" },
    { "size": "60x60", "idiom": "iphone", "filename": "icon-60@3x.png", "scale": "3x" },

    { "size": "76x76", "idiom": "ipad", "filename": "icon-76@2x.png", "scale": "2x" },
    { "size": "83.5x83.5", "idiom": "ipad", "filename": "icon-83.5@2x.png", "scale": "2x" },

    { "size": "1024x1024", "idiom": "ios-marketing", "filename": "Icon-AppStore-1024.png", "scale": "1x" }
  ],
  "info": { "version": 1, "author": "xcode" }
}
EOF

          echo "âœ… Icons replaced successfully!"

      - name: ðŸ› ï¸ Install CocoaPods
        run: gem install cocoapods

      - name: ðŸ”„ Capacitor Sync
        run: npx cap sync ios

      - name: ðŸ—ï¸ Pod Install (iOS)
        run: cd ios/App && pod install --repo-update

      - name: ðŸŽ Build iOS (Unsigned IPA manually)
        run: |
          BUILD_DIR=$(pwd)/build
          mkdir -p $BUILD_DIR

          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            BUILD_DIR="$BUILD_DIR" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="-" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM=""

          APP_PATH=$(find $BUILD_DIR/Release-iphoneos -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ ERROR: .app not found. Build likely failed."
            exit 1
          fi

          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          zip -r Parma_nel_Mondo_unsigned.ipa Payload

          mkdir -p build/ipa
          mv Parma_nel_Mondo_unsigned.ipa build/ipa/

      - name: â¬†ï¸ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Parma-nel-Mondo-Unsigned-IPA
          path: build/ipa/Parma_nel_Mondo_unsigned.ipa
          retention-days: 1
